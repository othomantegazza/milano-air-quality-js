---
title: "Milano Air Quality Dashboard"
editor_options: 
  chunk_output_type: console
---

```{r notes}
#| include: false
# https://www.eea.europa.eu/themes/air/air-quality-concentrations/AirQlimitvalues.png
# https://environment.ec.europa.eu/topics/air/air-quality/eu-air-quality-standards_en
# https://dati.comune.milano.it/dataset/ds573-valori-rilevati-per-i-principali-inquinanti-dell-aria
```

<!--- js dependencies -->
<script src="time-series-dot.js"></script> 
<script src="https://d3js.org/d3.v7.min.js"></script> 

```{r rpackages}
#| include: false
library(tidyverse)
library(here)
library(tsibble)
library(lubridate)
library(janitor)
```

```{r, pollutants}
#| include: false
# from https://environment.ec.europa.eu/topics/air/air-quality/eu-air-quality-standards_en
pollutants <- 
  tribble(~inquinante, ~pollutant_name, ~eu_limits,
          'C6H6', 'Polycyclic Aromatic Hydrocarbons', 1e-3,
          'CO_8h', 'Carbon monoxide', 1e4,
          'NO2', 'Nitrogen dioxide', 40,
          'O3', 'Ozone', 120,
          'PM10', 'Particulate matter', 40,
          'PM25', 'Fine particles', 20,
          'SO2', 'Sulphur dioxide', 125,
          )
```

```{r}
#| include: false
air_q_url <-
  'data/aq.csv'

air_q <- 
  air_q_url %>% 
  readr::read_csv() %>% 
  janitor::clean_names() %>% 
  rename(date = data) %>% 
  mutate(date = date %>% as_date()) %>% 
  # guessing real order of magnitude of measuremnts
  mutate(valore = valore %>% {
    case_when(inquinante == 'C6H6' ~ . * 1e-3,
              inquinante == 'CO_8h' ~ . * 1e3,
              TRUE ~ .)
  })

ozone <- 
  air_q %>% 
  filter(inquinante == 'O3') %>% 
  drop_na()

ojs_define(ozone_in = ozone)
```

```{ojs}
//| echo: false
ozone = transpose(ozone_in)

chart = Scatterplot(ozone, {
  x: d => Date.parse(d.date)    ,
  y: d => d.valore,
  xType: d3.scaleTime,
  xLabel: "Miles per gallon →",
  yLabel: "↑ Horsepower",
  stroke: "steelblue",
  width,
  height: 600
})
```

